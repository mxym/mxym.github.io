---
import MainGridLayout from "../layouts/MainGridLayout.astro";
import { Icon } from "astro-icon/components";

// ============================================
// ğŸ‘‡ æ•°æ®é…ç½®åŒº
// ============================================
const friendsData = [
    {
        name: "ItsFlicker",
        url: "https://blog.mcitd.cn/about/",
        avatar: "https://blog.mcitd.cn/_astro/avatar.zT8EqTHN_S4v1p.webp",
        description: "",
        tags: ["Pwn", "Kap0k"]
    },
    {
        name: "xNftrOne",
        url: "https://www.cnblogs.com/xNftrOne",
        avatar: "https://ooo.0x0.ooo/2025/05/27/OdV7Q6.jpg",
        description: "hamburgeræ–¹å‘åˆ›å§‹äºº",
        tags: ["Web", "Kap0k"]
    },
    {
        name: "L1nk",
        url: "https://li1nk3.github.io/",
        avatar: "https://li1nk3.github.io/image/icon.jpg",
        description: "Live long and pwn",
        tags: ["Pwn", "Kap0k"]
    },
    {
        name: "Mik0ui",
        url: "https://mikouiblog.vercel.app/",
        avatar: "https://mikouiblog.vercel.app/_astro/ui.BM1qpdMw_kO5nV.webp",
        description: "Always be myself.",
        tags: ["Misc", "Kap0k"]
    },
    {
        name: "Astral Prisma",
        url: "https://astralprisma.github.io/",
        avatar: "https://astralprisma.github.io/AP.png",
        description: "ç®€ç›´æ˜¯Reä¹‹ç¥",
        tags: ["Reverse"]
    },
];

const allTags = ["å…¨éƒ¨", ...new Set(friendsData.flatMap(f => f.tags))];
---

<MainGridLayout title="å‹é“¾" description="å‘ç°æ›´å¤šä¼˜ç§€ç½‘ç«™">
    <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
        <div class="card-base z-10 px-9 py-6 relative w-full bg-[#1e293b] text-blue-100">

            <div class="mb-6">
                <h1 class="text-3xl font-bold mb-2 text-blue-50">ğŸ¤ å‹é“¾</h1>
                <p class="opacity-80 text-blue-200">å‘ç°æ›´å¤šä¼˜ç§€çš„ CTF é€‰æ‰‹å’ŒæŠ€æœ¯åšå®¢</p>
            </div>

            <div class="relative mb-6">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <Icon name="fa6-solid:magnifying-glass" class="text-blue-400" />
                </div>
                <input
                    type="text"
                    id="friend-search"
                    placeholder="æœç´¢å‹é“¾åç§°æˆ–æè¿°..."
                    class="w-full pl-10 pr-4 py-3 rounded-xl bg-[#334155] border border-blue-800 placeholder-blue-400 text-blue-100 outline-none focus:ring-2 focus:ring-blue-500 transition-all text-sm"
                >
            </div>

            <div class="flex flex-wrap gap-2 mb-8" id="tag-container">
                {allTags.map((tag, index) => (
                    <button
                        data-tag={tag}
                        class:list={[
                            "px-4 py-1.5 rounded-full text-sm font-medium transition-all duration-300 tag-btn",
                            index === 0
                                ? "bg-blue-600 text-white shadow-md active"
                                : "bg-[#334155] text-blue-300 hover:bg-blue-600 hover:text-white"
                        ]}
                    >
                        {tag}
                    </button>
                ))}
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="friends-grid">
                {friendsData.map((friend) => (
                    <div
                        class="friend-card group relative flex flex-col p-5 rounded-2xl bg-[#283548] border border-blue-900/50 hover:border-blue-500 transition-all duration-300 hover:shadow-lg hover:-translate-y-1"
                        data-name={friend.name.toLowerCase()}
                        data-desc={friend.description.toLowerCase()}
                        data-tags={friend.tags.join(",")}
                    >
                        <div class="flex items-center mb-4">
                            <a href={friend.url} target="_blank" class="flex-shrink-0 mr-4 cursor-pointer">
                                <img
                                    src={friend.avatar}
                                    alt={friend.name}
                                    class="w-16 h-16 rounded-2xl object-cover shadow-sm group-hover:scale-105 transition-transform duration-300 ring-2 ring-blue-900/30"
                                    loading="lazy"
                                />
                            </a>
                            <div class="overflow-hidden">
                                <a href={friend.url} target="_blank" class="block font-bold text-lg truncate text-blue-50 hover:text-blue-400 transition-colors">
                                    {friend.name}
                                </a>
                                <p class="text-xs opacity-60 mt-0.5 truncate font-mono text-blue-300">
                                    {friend.url.replace(/^https?:\/\//, '').replace(/\/$/, '')}
                                </p>
                            </div>
                        </div>

                        <p class="text-sm opacity-80 line-clamp-2 mb-6 h-10 leading-5 text-blue-200">
                            {friend.description || "æš‚æ— æè¿°"}
                        </p>

                        <div class="mt-auto flex items-center justify-between">
                            <div class="flex gap-2 text-xs opacity-60 font-mono text-blue-300">
                                {friend.tags.slice(0, 3).map(t => (
                                    <span>#{t}</span>
                                ))}
                            </div>

                            <div class="flex gap-2">
                                <a
                                    href={friend.url}
                                    target="_blank"
                                    class="px-4 py-1.5 rounded-lg bg-blue-600 text-white text-xs font-bold hover:bg-blue-500 active:scale-95 transition-all flex items-center gap-1 shadow-sm"
                                >
                                    <Icon name="fa6-solid:arrow-up-right-from-square" />
                                    è®¿é—®
                                </a>
                                <button
                                    class="copy-btn w-8 h-8 flex items-center justify-center rounded-lg bg-[#334155] text-blue-400 hover:bg-blue-600 hover:text-white transition-all active:scale-95 border border-blue-800/50"
                                    data-url={friend.url}
                                    aria-label="å¤åˆ¶é“¾æ¥"
                                >
                                    <Icon name="fa6-regular:copy" />
                                </button>
                            </div>
                        </div>
                    </div>
                ))}
            </div>

            <div id="no-result" class="hidden text-center py-12 opacity-60 text-blue-300">
                <Icon name="fa6-solid:ghost" class="text-4xl mx-auto mb-2" />
                <p>æ²¡æœ‰æ‰¾åˆ°ç›¸å…³çš„å°ä¼™ä¼´...</p>
            </div>

        </div>
    </div>
</MainGridLayout>

<script is:inline>
(function() {
    const searchInput = document.getElementById('friend-search');
    const tagContainer = document.getElementById('tag-container');
    const cards = document.querySelectorAll('.friend-card');
    const noResult = document.getElementById('no-result');
    const copyBtns = document.querySelectorAll('.copy-btn');

    // é»˜è®¤çŠ¶æ€
    let currentTag = 'å…¨éƒ¨';
    let currentSearch = '';

    // 1. æ ¸å¿ƒç­›é€‰å‡½æ•°
    function filterFriends() {
        let visibleCount = 0;

        cards.forEach(card => {
            const name = card.dataset.name || '';
            const desc = card.dataset.desc || '';
            const tags = (card.dataset.tags || '').split(',');

            // æ£€æŸ¥æ ‡ç­¾åŒ¹é…
            const matchTag = currentTag === 'å…¨éƒ¨' || tags.includes(currentTag);
            // æ£€æŸ¥æœç´¢åŒ¹é…
            const matchSearch = name.includes(currentSearch) || desc.includes(currentSearch);

            if (matchTag && matchSearch) {
                card.classList.remove('hidden');
                visibleCount++;
            } else {
                card.classList.add('hidden');
            }
        });

        // æ˜¾ç¤º/éšè—â€œæ— ç»“æœâ€æç¤º
        if (noResult) {
            if (visibleCount > 0) {
                noResult.classList.add('hidden');
            } else {
                noResult.classList.remove('hidden');
            }
        }
    }

    // 2. æ ‡ç­¾ç‚¹å‡»äº‹ä»¶ (ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œç»‘å®šåœ¨çˆ¶å®¹å™¨ä¸Š)
    if (tagContainer) {
        tagContainer.addEventListener('click', (e) => {
            // æ‰¾åˆ°è¢«ç‚¹å‡»çš„æŒ‰é’®
            const targetBtn = e.target.closest('.tag-btn');
            if (!targetBtn) return; // å¦‚æœç‚¹çš„ä¸æ˜¯æŒ‰é’®ï¼Œå¿½ç•¥

            // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„é«˜äº®æ ·å¼
            const allBtns = tagContainer.querySelectorAll('.tag-btn');
            allBtns.forEach(b => {
                b.classList.remove('bg-blue-600', 'text-white', 'shadow-md', 'active');
                b.classList.add('bg-[#334155]', 'text-blue-300');
            });

            // é«˜äº®å½“å‰æŒ‰é’®
            targetBtn.classList.remove('bg-[#334155]', 'text-blue-300');
            targetBtn.classList.add('bg-blue-600', 'text-white', 'shadow-md', 'active');

            // æ›´æ–°çŠ¶æ€å¹¶ç­›é€‰
            currentTag = targetBtn.dataset.tag || 'å…¨éƒ¨';
            filterFriends();
        });
    }

    // 3. æœç´¢æ¡†è¾“å…¥äº‹ä»¶
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            currentSearch = e.target.value.toLowerCase();
            filterFriends();
        });
    }

    // 4. å¤åˆ¶åŠŸèƒ½
    copyBtns.forEach(btn => {
        btn.addEventListener('click', async (e) => {
            // é˜»æ­¢å†’æ³¡ï¼Œé˜²æ­¢è§¦å‘å¡ç‰‡çš„ç‚¹å‡»ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            e.stopPropagation();

            const url = btn.dataset.url || '';
            try {
                await navigator.clipboard.writeText(url);

                // å˜ç»¿åé¦ˆ
                const icon = btn.querySelector('svg');
                if(icon) {
                    const originalColor = icon.style.color;
                    icon.style.color = '#4ade80';
                    setTimeout(() => icon.style.color = originalColor || '', 1000);
                }
            } catch (err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
            }
        });
    });
})();
</script>